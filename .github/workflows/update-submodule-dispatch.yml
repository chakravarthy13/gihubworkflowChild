name: Update submodule when notified

# Purpose: Listen for `repository_dispatch` events (type: submodule-updated)
# sent from the Main repository. When received, this workflow updates the
# local `gihubworkflowMain` submodule to the remote's latest commit, commits
# the gitlink change in the Child repo, and pushes it back to the Child repo's
# `ChildBranch01` branch.

on:
  repository_dispatch:
    types: [ submodule-updated ]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout the repository and initialize submodules
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # 2) Update submodule pointer and push changes
      - name: Update submodule
        run: |
          # Configure committer identity
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Parent HEAD: $(git rev-parse --short HEAD)"
          echo "Submodule recorded SHA:"
          git submodule status -- gihubworkflowMain || true

          # Fetch latest refs in the submodule
          git -C gihubworkflowMain fetch origin --quiet || true
          echo "Remote refs for submodule:"
          git -C gihubworkflowMain ls-remote origin | sed -n '1,5p'

          # Checkout remote main branch in the submodule
          git -C gihubworkflowMain checkout origin/main || true
          echo "Submodule new HEAD: $(git -C gihubworkflowMain rev-parse --short HEAD)"

          # Stage the submodule gitlink change
          git add gihubworkflowMain

          # If no staged changes, exit cleanly
          if git diff --cached --quiet; then
            echo "No update needed"
            exit 0
          fi

          # Commit and push the updated submodule pointer
          git commit -m "Update submodule to latest"
          git push origin HEAD:ChildBranch01

      # 3) Debug info after push
      - name: Debug info
        run: |
          git status
          git log --oneline -n 3